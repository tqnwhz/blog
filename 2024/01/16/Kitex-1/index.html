<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/octocat.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/octocat.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/octocat.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="QcnjNHRiBLebjx8vMmLKX4v6WLuLRGHKSF9_I1fGmWY">
  <meta name="msvalidate.01" content="1D9AB23CC25B14EF5C62CCB4FC9B2069">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"tqnwhz.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":true,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>
<meta name="description" content="摘要 Kitex 是字节跳动开源的 Golang 微服务 RPC 框架，基于 Apache Thrift，具有高性能、强可扩展的特点，在字节内部已广泛使用。本篇是 Kitex 入门系列的第一篇，梳理相关的概念，并从案例上手实践。">
<meta property="og:type" content="article">
<meta property="og:title" content="RPC 微服务框架 Kitex 的入门实践">
<meta property="og:url" content="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/index.html">
<meta property="og:site_name" content="一隅">
<meta property="og:description" content="摘要 Kitex 是字节跳动开源的 Golang 微服务 RPC 框架，基于 Apache Thrift，具有高性能、强可扩展的特点，在字节内部已广泛使用。本篇是 Kitex 入门系列的第一篇，梳理相关的概念，并从案例上手实践。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/Apache_Thrift_architecture.png">
<meta property="og:image" content="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/kitex_arch.png">
<meta property="article:published_time" content="2024-01-16T03:14:46.000Z">
<meta property="article:modified_time" content="2024-01-18T07:48:23.561Z">
<meta property="article:author" content="Tqnwhz">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="字节跳动">
<meta property="article:tag" content="RPC">
<meta property="article:tag" content="Kitex">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/Apache_Thrift_architecture.png">


<link rel="canonical" href="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/","path":"2024/01/16/Kitex-1/","title":"RPC 微服务框架 Kitex 的入门实践"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>RPC 微服务框架 Kitex 的入门实践 | 一隅</title>
  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">一隅</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%91%98%E8%A6%81"><span class="nav-number">1.</span> <span class="nav-text">摘要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#thrift"><span class="nav-number">2.</span> <span class="nav-text">Thrift</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.2.</span> <span class="nav-text">服务端模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#idl"><span class="nav-number">2.3.</span> <span class="nav-text">IDL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.3.1.</span> <span class="nav-text">基础数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.3.2.</span> <span class="nav-text">特殊类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.3.3.</span> <span class="nav-text">结构体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8"><span class="nav-number">2.3.4.</span> <span class="nav-text">容器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8"><span class="nav-number">2.3.5.</span> <span class="nav-text">异常</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.3.6.</span> <span class="nav-text">服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.3.7.</span> <span class="nav-text">枚举类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F"><span class="nav-number">2.3.8.</span> <span class="nav-text">常量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D"><span class="nav-number">2.3.9.</span> <span class="nav-text">类型别名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">2.3.10.</span> <span class="nav-text">命名空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">2.3.11.</span> <span class="nav-text">最佳实践</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kitex"><span class="nav-number">3.</span> <span class="nav-text">Kitex</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84-1"><span class="nav-number">3.1.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B"><span class="nav-number">3.2.</span> <span class="nav-text">快速上手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#handler.go"><span class="nav-number">3.3.</span> <span class="nav-text">handler.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main.go"><span class="nav-number">3.4.</span> <span class="nav-text">main.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kitex_info.yaml"><span class="nav-number">3.5.</span> <span class="nav-text">kitex_info.yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kitex_gen"><span class="nav-number">3.6.</span> <span class="nav-text">kitex_gen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-number">3.7.</span> <span class="nav-text">运行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tqnwhz"
      src="/blog/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Tqnwhz</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/tqnwhz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tqnwhz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/blog/tqnwhz@gmail.com" title="E-Mail → tqnwhz@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="Tqnwhz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一隅">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RPC 微服务框架 Kitex 的入门实践
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-16 11:14:46" itemprop="dateCreated datePublished" datetime="2024-01-16T11:14:46+08:00">2024-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-18 15:48:23" itemprop="dateModified" datetime="2024-01-18T15:48:23+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>17 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="摘要">摘要</h2>
<p>Kitex 是字节跳动开源的 Golang 微服务 RPC 框架，基于 Apache
Thrift，具有<strong>高性能</strong>、<strong>强可扩展</strong>的特点，在字节内部已广泛使用。本篇是 Kitex 入门系列的第一篇，梳理相关的概念，并从案例上手实践。
<span id="more"></span></p>
<h2 id="thrift">Thrift</h2>
<p><a target="_blank" rel="noopener" href="https://thrift.apache.org/"><code>Thrift</code></a>是一个<strong>轻量级</strong>、<strong>跨语言</strong>的<strong>远程服务调用（Remove
Procedure
Call，RPC）</strong>框架，最初由 <code>Facebook</code> 开发，后面进入 <code>Apache</code> 开源项目。它通过自身的 <code>IDL</code><strong>中间语言（Interface
Description Language，接口描述语言）</strong>,
并借助<strong>代码生成引擎</strong>生成各种主流语言的 <code>RPC</code><strong>服务端</strong> / <strong>客户端</strong>模板代码。</p>
<p>Thrift 的一大优势就是可以跨语言代码生成，支持 C++, Java, Python, PHP,
Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js 等语言。</p>
<h3 id="架构">架构</h3>
<p>Thrift API 的客户端 - 服务端架构图如下所示：</p>
<ul>
<li>顶层是根据 IDL 生成的客户端 / 服务端代码</li>
<li>协议层（TProtocol）定义了序列化和反序列化的协议，包含 TBinaryProtocol
（二进制协议）、TCompactProtocol
（压缩二进制协议）、TJSONProtocol（JSON 文本）、TSimpleJSONProtocol
等</li>
<li>传输层（TTransport）定义了网络传输的方式，基于 TCP/IP 协议，包含 TSocket（阻塞 Socket）、TSimpleFileTransport（文件传输）、TFramedTransport（帧传输）等</li>
</ul>
<p><img src="Apache_Thrift_architecture.png"></p>
<h3 id="服务端模型">服务端模型</h3>
<p>Thrift 支持以下几种服务端模型：</p>
<ul>
<li>TSimpleServer：简单的单线程服务模型，常用于测试；</li>
<li>TThreadedServer：多线程服务模型，每个连接新建线程，使用标准阻塞 IO；</li>
<li>TThreadPoolServer：多线程服务模型，使用<strong>线程池</strong>，使用标准的阻塞式 IO；</li>
<li>TNonblockingServer：多线程服务模型，使用非阻塞式 IO（需使用 TFramedTransport 数据传输方式）；</li>
</ul>
<h3 id="idl">IDL</h3>
<h4 id="基础数据类型"><strong>基础数据类型</strong></h4>
<ul>
<li>bool：布尔型（true or false）；</li>
<li>byte：8bit、有符号整型。</li>
<li>i16、i32、i64：16/32/64 bit 有符号整型。</li>
<li>double：64 位浮点数</li>
<li> string：UTF-8 字符串</li>
</ul>
<p>没有定义无符号整数类型，因为很多语言中没有原生的无符号整数类型。</p>
<h4 id="特殊类型"><strong>特殊类型</strong></h4>
<ul>
<li>binary：字节序列</li>
</ul>
<h4 id="结构体"><strong>结构体</strong></h4>
<p>使用 struct 定义，一系列字段的集合，不支持继承。一个例子如下所示。结构体中每个字段需要用唯一的整型标识，用于序列化与反序列化，可以通过 <code>required/optional</code> 关键字定义字段是否必须，可以用 <code>=</code> 指定默认值。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct Work {</span><br><span class="line">  1: i32 num1 = 0</span><br><span class="line">  2: required i32 num2</span><br><span class="line">  3: string op</span><br><span class="line">  4: optional string comment</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Thrift 支持以下三种字段必要性标识，决定了序列化和反序列化的行为：</p>
<p><strong>required</strong></p>
<ul>
<li>写：字段总是被写入，需要被赋值</li>
<li>读：字段总是被读取，输入流中必须包含，如果缺失则会<strong>抛出异常</strong>或者返回 error</li>
<li> 默认值：总是被写入</li>
<li> required 字段会限制版本的平滑过渡。如果新增 / 移除了 required 字段，都可能导致读取失败。</li>
</ul>
<p><strong>optional</strong></p>
<ul>
<li>写：只有被设置了才会被写入</li>
<li>读：可能出现在输入流中，也可以不存在</li>
<li>默认值：只有当设置了 <code>isset</code> 标识才会写入</li>
<li>很多语言的实现中，使用 <code>isset</code> 标识可选字段是否被赋值。只有设置了这个标识的字段才会被写入，反过来只有输入流中存在该字段才会设置 <code>isset</code></li>
</ul>
<p><strong>default（隐式默认）</strong></p>
<ul>
<li>写：理论上，总是被写入，除非特殊情况</li>
<li>读：与 optional 类似，可能出现在输入流中，也可以不存在</li>
<li>默认值：可能不会被写入</li>
</ul>
<p>default 类似 required 和 optional 的混合，取决于具体的实现。例如，实现中可以不写入默认值，因为假设读取时会自动补充默认值；也可以写入默认值，没有限制不能这么做。</p>
<p>需要注意的是，未写入的默认值成为了 idl 版本的一部分，如果后续默认值出现了变更，接口就会发生变化。而如果默认值被写入了，即使 IDL 中的默认值改变，也不会影响序列化数据。</p>
<ul>
<li>也就是说，不把默认值写入，读取侧只能依赖于 idl 中的默认值填充。写入了默认值，读取侧就可以只从数据中读取了。</li>
</ul>
<h4 id="容器"><strong>容器</strong></h4>
<ul>
<li>map&lt;type1,type2&gt;：键值字典</li>
<li> list&lt;type&gt;：有序列表</li>
<li> set&lt;type&gt;：无序集合</li>
</ul>
<p>理论上，容器的类型可以是任意合法的 Thrift 类型。但为了兼容性考虑，map 的 key 应当是基础类型。这是由于一些语言不允许复杂的键类型。此外，JSON 中也只支持基础类型的 key。</p>
<h4 id="异常">异常</h4>
<p>异常在语法和功能上类似于结构体，只不过异常使用关键字 exception 而不是 struct 关键字声明。但它在语义上不同于结构体，当定义一个 RPC 服务时，开发者可能需要声明一个远程方法抛出一个异常。在 Golang 中，不使用异常机制，因此可以忽略。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exception InvalidOperation {</span><br><span class="line">  1: i32 what,</span><br><span class="line">  2: string why </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="服务">服务</h4>
<p>服务类似于接口，是一系列抽象函数的集合。函数的声明与 C 中文法类似，返回类型在最前，然后是函数名、参数列表（每个参数需要整型 id 标识）。一个例子如下所示，函数可以使用 <code>oneway</code> 标识符表示 client 发出请求后不必等待结果，也就是异步调用。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//“Twitter”与“{”之间需要有空格！！！</span><br><span class="line">service Twitter {</span><br><span class="line">    // 方法定义方式类似于C语言中的方式，它有一个返回值，一系列参数和可选的异常</span><br><span class="line">    // 列表. 注意，参数列表和异常列表定义方式与结构体中域定义方式一致.</span><br><span class="line">    void ping()                       // 函数定义可以使用逗号或者分号标识结束</span><br><span class="line">    bool postTweet(1:Tweet tweet)    // 参数可以是基本类型或者结构体，参数是只读的（const），不可以作为返回值！！！</span><br><span class="line">    TweetSearchResult searchTweets(1:string query) // 返回值可以是基本类型或者结构体</span><br><span class="line">    // ”oneway”标识符表示client发出请求后不必等待回复（非阻塞）直接进行下面的操作，</span><br><span class="line">    // ”oneway”方法的返回值必须是void</span><br><span class="line">    oneway void zip()               // 返回值可以是void</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>service 可以通过 <code>extends</code> 关键字继承另一个 service。</p>
<h4 id="枚举类型">枚举类型</h4>
<p>使用 <code>enum</code> 关键字定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">TweetType</span> </span>{</span><br><span class="line">    TWEET,         <span class="comment">// 编译器默认从1开始赋值</span></span><br><span class="line">    RETWEET = <span class="number">2</span>,  <span class="comment">// 可以赋予某个常量某个整数</span></span><br><span class="line">    DM = <span class="number">0xa</span>,     <span class="comment">//允许常量是十六进制整数</span></span><br><span class="line">    REPLY         <span class="comment">// 末尾没有逗号</span></span><br><span class="line">}        </span><br></pre></td></tr></tbody></table></figure>
<p>令人难过的是，Golang 中没有原生的枚举类型。</p>
<h4 id="常量">常量</h4>
<p>使用 <code>const</code> 关键字定义，复杂的类型和结构体可使用 JSON 形式表示。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> i32 INT_CONST = <span class="number">1234</span>;    <span class="comment">// 分号是可选的</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt; MAP_CONST = {<span class="string">"hello"</span>: <span class="string">"world"</span>, <span class="string">"goodnight"</span>: <span class="string">"moon"</span>}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="类型别名">类型别名</h4>
<p>与 C 类似，可以使用 <code>typedef</code> 关键字为类型声明别名</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> i32 MyInteger </span><br></pre></td></tr></tbody></table></figure>
<h4 id="命名空间">命名空间</h4>
<p><code>namespace</code> 关键字，可以为每种语言单独声明，用于隔离代码（例如 Go
module、Java package 等），语法如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">namespace cpp com.example.project </span><br><span class="line">namespace java com.example.project </span><br></pre></td></tr></tbody></table></figure>
<h4 id="最佳实践">最佳实践</h4>
<ul>
<li>struct 中任何新加的字段都不能是 <code>required</code>，以防新旧版本不兼容出现的报错。</li>
<li>不要修改 struct 中已有字段的 id 值。</li>
<li>非必须的字段可以移除，但 id 值不要复用。更好的方式是使用 <code>OBSOLETE_</code>前缀标识已被废弃。</li>
<li>可以更改默认值，但要牢记默认值不会序列化，接收方会使用自身的 idl 填充默认值，导致不一致。</li>
</ul>
<h2 id="kitex">Kitex</h2>
<h3 id="架构-1">架构</h3>
<p>Thrift 可以实现 idl 的定义与客户端 / 服务端代码生成，通过传输层和协议层完成 RPC 交互，但缺失 RPC 框架的高级特性，例如服务注册、发现、监控等。为此，字节结合内部的治理能力，开发了 <a target="_blank" rel="noopener" href="https://www.cloudwego.io/zh/docs/kitex/overview/"><code>Kitex</code></a>框架，架构如下所示：</p>
<p><img src="kitex_arch.png"></p>
<p>可以看到，Kitex 以模块化的方式，支持服务注册 / 发现、负载均衡、熔断、限流、重试、监控、链路跟踪、日志、诊断等服务治理模块，大部分均已提供默认扩展，使用者可选择集成。</p>
<p>此外，Kitex 还支持不同的第三方包，例如使用了自研的高性能网络库 <a target="_blank" rel="noopener" href="https://github.com/cloudwego/netpoll">Netpoll</a>，通过 epoll + 协程池，提高网络 IO 性能。KItex 也支持多种消息协议，包含 <strong>Thrift</strong>、<strong>Kitex
Protobuf</strong>、<strong>gRPC</strong> 等，以及多种传输协议，包含
<strong>TTHeader</strong>、<strong>HTTP2</strong> 等。</p>
<h3 id="快速上手">快速上手</h3>
<p>按照<a target="_blank" rel="noopener" href="https://www.cloudwego.io/zh/docs/kitex/getting-started/">快速开始
| CloudWeGo</a> 安装 Go 环境与 kitex 工具。</p>
<p>新建项目 <code>kitex_started</code>，新建如下的 idl 文件 <code>hello.thrift</code>：</p>
<figure class="highlight thrift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> go hello_world</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">HelloType</span> </span>{</span><br><span class="line">    Morning = <span class="number">1</span>,</span><br><span class="line">    Noon = <span class="number">2</span>,</span><br><span class="line">    Afternoon = <span class="number">3</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Request</span> </span>{</span><br><span class="line">    <span class="number">1</span>: <span class="keyword">required</span> <span class="built_in">i64</span> id,</span><br><span class="line">    <span class="number">2</span>: <span class="keyword">required</span> <span class="built_in">string</span> message,</span><br><span class="line">    <span class="number">3</span>: <span class="keyword">optional</span> HelloType type,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Response</span> </span>{</span><br><span class="line">    <span class="number">1</span>: <span class="keyword">required</span> <span class="built_in">string</span> message,</span><br><span class="line">    <span class="number">2</span>: <span class="keyword">optional</span> <span class="built_in">string</span> error,</span><br><span class="line">    <span class="number">3</span>: <span class="keyword">optional</span> list&lt;<span class="keyword">i64</span>&gt; ids,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AddRequest</span> </span>{</span><br><span class="line">    <span class="number">1</span>: <span class="keyword">required</span> <span class="built_in">i64</span> first,</span><br><span class="line">    <span class="number">2</span>: <span class="keyword">required</span> <span class="built_in">i64</span> second,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AddResponse</span> </span>{</span><br><span class="line">    <span class="number">1</span>: <span class="keyword">required</span> <span class="built_in">i64</span> sum,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Hello</span> </span>{</span><br><span class="line">    Response echo(<span class="number">1</span>: Request req),</span><br><span class="line">    AddResponse add(<span class="number">1</span>: AddRequest req),</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在 idl 中，定义了一个服务，两个函数。然后使用如下命令进行代码生成，<code>-module</code> 用于指定包名，需要与 <code>go.mod</code> 中的一致，<code>-service</code> 表示生成服务端代码，并指定了<strong>服务名</strong>，最后是 idl 的路径。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kitex -module <span class="string">"kitex_started"</span> -service a.b.c hello.thrift</span><br></pre></td></tr></tbody></table></figure>
<p>接着会发现，<code>go.mod</code> 包含以下内容，注意 replace 一行是由于 kitex 使用的是 0.13.0 版本的 thrift，高版本的不兼容。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">module kitex_started</span><br><span class="line"></span><br><span class="line">go 1.21</span><br><span class="line"></span><br><span class="line">replace github.com/apache/thrift =&gt; github.com/apache/thrift v0.13.0</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">	github.com/apache/thrift v0.13.0</span><br><span class="line">	github.com/cloudwego/kitex v0.8.0</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>接着，运行 <code>go mod
tidy</code> 安装依赖，就不会有红线报错了。我们得到了如下的项目结构：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">❯ tree -r                                                                                                          </span><br><span class="line">.</span><br><span class="line">├── script</span><br><span class="line">│&nbsp;&nbsp; └── bootstrap.sh</span><br><span class="line">├── main.go</span><br><span class="line">├── kitex_info.yaml</span><br><span class="line">├── kitex_gen</span><br><span class="line">│&nbsp;&nbsp; └── hello_world</span><br><span class="line">│&nbsp;&nbsp;     ├── k-hello.go</span><br><span class="line">│&nbsp;&nbsp;     ├── k-consts.go</span><br><span class="line">│&nbsp;&nbsp;     ├── hello.go</span><br><span class="line">│&nbsp;&nbsp;     └── hello</span><br><span class="line">│&nbsp;&nbsp;         ├── server.go</span><br><span class="line">│&nbsp;&nbsp;         ├── invoker.go</span><br><span class="line">│&nbsp;&nbsp;         ├── hello.go</span><br><span class="line">│&nbsp;&nbsp;         └── client.go</span><br><span class="line">├── idl</span><br><span class="line">│&nbsp;&nbsp; └── hello.thrift</span><br><span class="line">├── handler.go</span><br><span class="line">├── go.sum</span><br><span class="line">├── go.mod</span><br><span class="line">└── build.sh</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="handler.go">handler.go</h3>
<p>服务的实现类，<code>$HelloImpl</code> 实现了 idl 中的 <code>Hello</code> 接口，不同的是，参数列表中增加了透传的 context，以及返回值中增加了 error。我们需要在这里实现业务逻辑。</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	hello_world <span class="string">"kitex_started/kitex_gen/hello_world"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloImpl implements the last service interface defined in the IDL.</span></span><br><span class="line"><span class="keyword">type</span> HelloImpl <span class="keyword">struct</span>{}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Echo implements the HelloImpl interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloImpl)</span> <span class="title">Echo</span><span class="params">(ctx context.Context, req *hello_world.Request)</span> <span class="params">(resp *hello_world.Response, err error)</span></span> {</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Your code here...</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add implements the HelloImpl interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloImpl)</span> <span class="title">Add</span><span class="params">(ctx context.Context, req *hello_world.AddRequest)</span> <span class="params">(resp *hello_world.AddResponse, err error)</span></span> {</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Your code here...</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="main.go">main.go</h3>
<p>项目的入口，代码很简单，新建了一个 server 并开始运行。注意这里 import 的路径不同，虽然都被重命名为了 <code>hello_world</code></p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	hello_world <span class="string">"kitex_started/kitex_gen/hello_world/hello"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	svr := hello_world.NewServer(<span class="built_in">new</span>(HelloImpl))</span><br><span class="line"></span><br><span class="line">	err := svr.Run()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		log.Println(err.Error())</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="kitex_info.yaml">kitex_info.yaml</h3>
<p>包含了服务名和版本信息。</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kitexinfo:</span></span><br><span class="line">   <span class="attr">ServiceName:</span> <span class="string">'a.b.c'</span></span><br><span class="line">   <span class="attr">ToolVersion:</span> <span class="string">'v0.8.0'</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="kitex_gen">kitex_gen</h3>
<p><code>hello_world</code> 包（idl 中的 namespace）下，有以下文件 / 目录：</p>
<ul>
<li><code>hello.go</code>：定义了 idl 中的各种类型，例如 <code>HelloType,Request,Response</code> 等，提供了 <code>Get/Set,
Read/Write</code> 方法</li>
<li><code>k-consts.go</code>：没什么用</li>
<li><code>k-hello.go</code>：各种类型的 FastRead/FastWrite
编解码实现，性能更好</li>
<li><code>hello/</code>：Hello Service 相关代码
<ul>
<li><code>client.go</code>：暴露 <code>NewClient</code> 函数，新建实现了 <code>Hello</code> 接口的 Client 对象</li>
<li><code>hello.go</code>：暴露 <code>NewServiceInfo</code> 函数，Service 信息，注意服务名是 idl 中的 Service，即 <code>Hello</code></li>
<li><code>server.go</code>：暴露 <code>NewServer</code> 函数，用于启动服务</li>
<li><code>invoker.go</code>：暴露 <code>NewInvoker</code> 函数，没有找到用法</li>
</ul></li>
</ul>
<p>分析目录结构可以看出，当我们需要新建某个 Service 的 Client/Server 时，需要 import 对应的 Service 包，使用 <code>NewClient/NewServer</code> 函数；如果只是使用 idl 中定义的结构体，只需要 import 对应 namespace 的包即可。这也解释了上面 import 路径的不同。</p>
<h3 id="运行">运行</h3>
<p>填好 handler 逻辑：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Echo implements the HelloImpl interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloImpl)</span> <span class="title">Echo</span><span class="params">(ctx context.Context, req *hello_world.Request)</span> <span class="params">(resp *hello_world.Response, err error)</span></span> {</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Your code here...</span></span><br><span class="line">	resp = &amp;hello_world.Response{Message: fmt.Sprintf(<span class="string">"Receive: %s"</span>, req.Message)}</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add implements the HelloImpl interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloImpl)</span> <span class="title">Add</span><span class="params">(ctx context.Context, req *hello_world.AddRequest)</span> <span class="params">(resp *hello_world.AddResponse, err error)</span></span> {</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Your code here...</span></span><br><span class="line">	resp = &amp;hello_world.AddResponse{Sum: req.First + req.Second}</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在 <code>client/main.go</code> 编写客户端代码：</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2021 CloudWeGo Authors</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">// you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">// You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">// distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">// See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">// limitations under the License.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"kitex_started/kitex_gen/hello_world"</span></span><br><span class="line">	<span class="string">"kitex_started/kitex_gen/hello_world/hello"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/cloudwego/kitex/client"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	client, err := hello.NewClient(<span class="string">"Hello"</span>, client.WithHostPorts(<span class="string">"0.0.0.0:8888"</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">for</span> {</span><br><span class="line">		req := &amp;hello_world.Request{</span><br><span class="line">			Id:      <span class="number">1</span>,</span><br><span class="line">			Message: <span class="string">"my request"</span>,</span><br><span class="line">		}</span><br><span class="line">		resp, err := client.Echo(context.Background(), req)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		}</span><br><span class="line">		log.Println(resp)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		addReq := &amp;hello_world.AddRequest{First: <span class="number">512</span>, Second: <span class="number">512</span>}</span><br><span class="line">		addResp, err := client.Add(context.Background(), addReq)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		}</span><br><span class="line">		log.Println(addResp)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>kitex
server 默认监听端口为 8888，可以通过 <code>WithServiceAddr</code> 配置。接着，在项目根目录运行 <code>go
run
.</code> 命令，可以观察到如下输出，证明服务端已启动，监听 8888 端口：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ go run .</span><br><span class="line">2024/01/17 20:02:44.944884 server.go:83: [Info] KITEX: server listen at addr=[::]:8888</span><br></pre></td></tr></tbody></table></figure>
<p>在另一个 shell 中运行 <code>go run
client/main.go</code>，可以得到如下输出：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">❯ go run client/main.go                                                                                             </span><br><span class="line">2024/01/17 20:02:51 Response({Message:Receive: my request Error:&lt;nil&gt; Ids:[]})</span><br><span class="line">2024/01/17 20:02:52 AddResponse({Sum:1024})</span><br></pre></td></tr></tbody></table></figure>
<p>证实客户端请求成功到达服务端，并正确处理返回。</p>
<h2 id="总结">总结</h2>
<p>本篇博客中，梳理了 Thrift 和 Kitex 的相关概念，通过一个简单的案例上手实践，分析项目结构并成功验证结果。作为框架的使用者，我们已经可以了解到基本用法，进一步深入原理是可选步骤。后面我会进一步分析请求的处理过程，来弄清楚易用性的背后，框架的底层运行机制是怎样的。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cloudwego.io/zh/docs/kitex/">Kitex |
CloudWeGo</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/45194118">Apache
Thrift 系列详解 (一) - 概述与入门 - 知乎 (zhihu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Apache_Thrift">Apache Thrift
- Wikipedia</a></li>
<li><a target="_blank" rel="noopener" href="https://thrift.apache.org/docs/idl.html">Apache Thrift -
Interface Description Language (IDL)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenny7/p/4224720.html">Thrift
的原理和使用 - 如果的事 - 博客园 (cnblogs.com)</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Tqnwhz
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/" title="RPC 微服务框架 Kitex 的入门实践">https://tqnwhz.github.io/blog/2024/01/16/Kitex-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/blog/tags/Golang/" rel="tag"><i class="fa fa-tag"></i> Golang</a>
              <a href="/blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 微服务</a>
              <a href="/blog/tags/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/" rel="tag"><i class="fa fa-tag"></i> 字节跳动</a>
              <a href="/blog/tags/RPC/" rel="tag"><i class="fa fa-tag"></i> RPC</a>
              <a href="/blog/tags/Kitex/" rel="tag"><i class="fa fa-tag"></i> Kitex</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2023/12/30/CSAPP-Lab-7/" rel="prev" title="CSAPP-Lab-7 实验报告: proxylab">
                  <i class="fa fa-chevron-left"></i> CSAPP-Lab-7 实验报告: proxylab
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2024/01/18/Hertz/" rel="next" title="HTTP 微服务框架 Hertz 的入门实践">
                  HTTP 微服务框架 Hertz 的入门实践 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tqnwhz</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">305k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:14</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><div>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date(2021,6,13);
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/blog/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"tqnwhz/blog","issue_term":"pathname","theme":"github-dark"}</script>
<script src="/blog/js/third-party/comments/utterances.js"></script>

</body>
</html>
